{"version":3,"sources":["webpack:///webpack/bootstrap ec17d7f861ec1d8ca572","webpack:///external \"babel-runtime/core-js/json/stringify\"","webpack:///external \"source-map-support/register\"","webpack:///external \"jsonwebtoken\"","webpack:///./jfs.js","webpack:///external \"babel-runtime/regenerator\"","webpack:///external \"babel-runtime/helpers/asyncToGenerator\"","webpack:///external \"middy\"","webpack:///external \"http-errors\"","webpack:///external \"middy/middlewares\"","webpack:///external \"pg\""],"names":["middy","require","createErr","urlEncodeBodyParser","httpErrorHandler","cors","jwt","Pool","pool","connectionString","process","env","dbUrl","databaseMiddleware","before","handler","next","connect","context","db","after","release","detectingResponseType","config","value","response","statusCode","body","message","curry","fn","use","module","exports","root","event","callback","register","JSON","parse","inviteCode","firstName","lastName","email","facebook_avatar","zip","friendQuery","text","values","query","friendResponse","console","log","rows","friendId","id","registerQuery","getQuery","getResponse","search","name","queryStringParameters","searchQuery","toLowerCase","searchResponse","getUser","pathParameters","userQuery","userResponse","facebookFriends","ids","facebookIds","split","influence","Authorization","headers","token","decoded","verify","jwtKey","influenceQuery","countResponse","count"],"mappings":";AAAA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;;AAGA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAK;AACL;AACA;;AAEA;AACA;AACA;AACA,mCAA2B,0BAA0B,EAAE;AACvD,yCAAiC,eAAe;AAChD;AACA;AACA;;AAEA;AACA,8DAAsD,+DAA+D;;AAErH;AACA;;AAEA;AACA;;;;;;;AC7DA,iE;;;;;;ACAA,wD;;;;;;ACAA,yC;;;;;;;ACAA;;;;;;;;;;;;;;;;;;AAEA,IAAMA,QAAQ,mBAAAC,CAAQ,CAAR,CAAd;AACA,IAAMC,YAAY,mBAAAD,CAAQ,CAAR,CAAlB;;eAKI,mBAAAA,CAAQ,CAAR,C;IAHFE,mB,YAAAA,mB;IACAC,gB,YAAAA,gB;IACAC,I,YAAAA,I;;AAEF,IAAIC,MAAM,mBAAAL,CAAQ,CAAR,CAAV;;gBAEiB,mBAAAA,CAAQ,CAAR,C;IAATM,I,aAAAA,I;;AAER,IAAMC,OAAO,IAAID,IAAJ,CAAS;AACpBE,oBAAkBC,QAAQC,GAAR,CAAYC;AADV,CAAT,CAAb;;AAIA,IAAMC,qBAAqB,SAArBA,kBAAqB;AAAA,SAAW;AACpCC;AAAA,0FAAQ,iBAAOC,OAAP,EAAgBC,IAAhB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,uBACqBR,KAAKS,OAAL,EADrB;;AAAA;AACNF,wBAAQG,OAAR,CAAgBC,EADV;;AAENH;;AAFM;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAAR;;AAAA;AAAA;AAAA;AAAA,OADoC;AAKpCI,WAAO,eAACL,OAAD,EAAUC,IAAV,EAAmB;AACxBD,cAAQG,OAAR,CAAgBC,EAAhB,CAAmBE,OAAnB,CAA2B,IAA3B;AACAL;AACD;AARmC,GAAX;AAAA,CAA3B;;AAWA;AACA,IAAMM,wBAAwB,SAAxBA,qBAAwB;AAAA,MAACC,MAAD,uEAAU,EAAV;AAAA,SAAkB;AAC9CH,WAAO,eAACL,OAAD,EAAUC,IAAV,EAAmB;AACxB;AACA,UAAIQ,QAAQT,QAAQU,QAApB;;AAEA,UAAID,UAAU,IAAd,EAAoB;AAClBA,gBAAQ;AACNE,sBAAY,GADN;AAENC,gBAAM;AACJC,qBAAS;AADL;AAFA,SAAR;AAMD,OAPD,MAOO;AACLJ,gBAAQ;AACNE,sBAAYH,OAAOG,UAAP,IAAqB,GAD3B;AAENC,gBAAM,yBAAeH,KAAf;AAFA,SAAR;AAID;;AAEDT,cAAQU,QAAR,GAAmBD,KAAnB;AACAR;AACD;AArB6C,GAAlB;AAAA,CAA9B;;AAwBA,IAAMa,QAAQ,SAARA,KAAQ,KAAM;AAClB,SAAO7B,MAAM8B,EAAN,EACJC,GADI,CACA5B,qBADA,EAEJ4B,GAFI,CAEA1B,MAFA,EAGJ0B,GAHI,CAGAlB,oBAHA,EAIJkB,GAJI,CAIA3B,kBAJA,EAKJ2B,GALI,CAKAT,uBALA,CAAP;AAMD,CAPD;;AASAU,OAAOC,OAAP,CAAeC,IAAf,GAAsBL,MAAM,UAACM,KAAD,EAAQjB,OAAR,EAAiBkB,QAAjB,EAA8B;AACxDA,WAAS,IAAT,EAAe,EAAER,SAAS,IAAX,EAAf;AACD,CAFqB,CAAtB;;AAIAI,OAAOC,OAAP,CAAeI,QAAf,GAA0BR;AAAA,uFAAM,kBAAOM,KAAP,EAAcjB,OAAd,EAAuBkB,QAAvB;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,0BAQ1BE,KAAKC,KAAL,CAAWJ,MAAMR,IAAjB,CAR0B,EAE5Ba,UAF4B,eAE5BA,UAF4B,EAG5BC,SAH4B,eAG5BA,SAH4B,EAI5BC,QAJ4B,eAI5BA,QAJ4B,EAK5BC,KAL4B,eAK5BA,KAL4B,EAM5BC,eAN4B,eAM5BA,eAN4B,EAO5BC,GAP4B,eAO5BA,GAP4B;AAUxBC,uBAVwB,GAUV;AAClBC,oBAAM,2EADY;AAElBC,sBAAQ,CAACR,UAAD;AAFU,aAVU;AAAA;AAAA,mBAcDtB,QAAQC,EAAR,CAAW8B,KAAX,CAAiBH,WAAjB,CAdC;;AAAA;AAcxBI,0BAdwB;;AAe9BC,oBAAQC,GAAR,CAAYN,WAAZ,EAAyBI,cAAzB;AACA,gBAAI,CAACA,eAAeG,IAAf,CAAoB,CAApB,CAAL,EAA6B;AAC3BjB,uBAASlC,UAAU,GAAV,EAAe,4BAAf,CAAT;AACD;AACKoD,oBAnBwB,GAmBbJ,eAAeG,IAAf,CAAoB,CAApB,EAAuBE,EAnBV;AAqBxBC,yBArBwB,GAqBR;AACpBT,uMADoB;AAKpBC,sBAAQ,CAACP,SAAD,EAAYC,QAAZ,EAAsBC,KAAtB,EAA6BC,eAA7B,EAA8CC,GAA9C,EAAmDS,QAAnD;AALY,aArBQ;AAAA;AAAA,mBA4BxBpC,QAAQC,EAAR,CAAW8B,KAAX,CAAiBO,aAAjB,CA5BwB;;AAAA;AA8BxBC,oBA9BwB,GA8Bb;AACfV,oBAAM,uDADS;AAEfC,sBAAQ,CAACL,KAAD;AAFO,aA9Ba;AAAA;AAAA,mBAkCJzB,QAAQC,EAAR,CAAW8B,KAAX,CAAiBQ,QAAjB,CAlCI;;AAAA;AAkCxBC,uBAlCwB;;;AAoC9BtB,qBAAS,IAAT,EAAesB,YAAYL,IAAZ,CAAiB,CAAjB,CAAf;;AApC8B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAN;;AAAA;AAAA;AAAA;AAAA,IAA1B;;AAuCArB,OAAOC,OAAP,CAAe0B,MAAf,GAAwB9B;AAAA,uFAAM,kBAAOM,KAAP,EAAcjB,OAAd,EAAuBkB,QAAvB;AAAA;AAAA;AAAA;AAAA;AAAA;AACtBwB,gBADsB,GACfzB,MAAM0B,qBAAN,CAA4BD,IADb;AAEtBE,uBAFsB,GAER;AAClBf,oBAAM,iGADY;AAElBC,sBAAQ,CAACY,KAAKG,WAAL,EAAD;AAFU,aAFQ;AAAA;AAAA,mBAMC7C,QAAQC,EAAR,CAAW8B,KAAX,CAAiBa,WAAjB,CAND;;AAAA;AAMtBE,0BANsB;;AAO5B5B,qBAAS,IAAT,EAAe4B,eAAeX,IAAf,CAAoB,CAApB,CAAf;;AAP4B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAN;;AAAA;AAAA;AAAA;AAAA,IAAxB;;AAUArB,OAAOC,OAAP,CAAegC,OAAf,GAAyBpC;AAAA,uFAAM,kBAAOM,KAAP,EAAcjB,OAAd,EAAuBkB,QAAvB;AAAA;AAAA;AAAA;AAAA;AAAA;AACvBmB,cADuB,GAClBpB,MAAM+B,cAAN,CAAqBX,EADH;AAEvBY,qBAFuB,GAEX;AAChBpB,oBAAM,oDADU;AAEhBC,sBAAQ,CAACO,EAAD;AAFQ,aAFW;AAAA;AAAA,mBAMFrC,QAAQC,EAAR,CAAW8B,KAAX,CAAiBkB,SAAjB,CANE;;AAAA;AAMvBC,wBANuB;;AAO7BhC,qBAAS,IAAT,EAAegC,aAAaf,IAAb,CAAkB,CAAlB,CAAf;;AAP6B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAN;;AAAA;AAAA;AAAA;AAAA,IAAzB;;AAUArB,OAAOC,OAAP,CAAeoC,eAAf,GAAiCxC;AAAA,uFAAM,kBAAOM,KAAP,EAAcjB,OAAd,EAAuBkB,QAAvB;AAAA;AAAA;AAAA;AAAA;AAAA;AAC/BkC,eAD+B,GACzBnC,MAAM0B,qBAAN,CAA4BS,GADH;AAE/BC,uBAF+B,GAEjBD,IAAIE,KAAJ,CAAU,GAAV,CAFiB;AAG/B1B,uBAH+B,GAGjB;AAClBC,oBAAM,8DADY;AAElBC,sBAAQ,CAACuB,WAAD;AAFU,aAHiB;AAAA;AAAA,mBAORrD,QAAQC,EAAR,CAAW8B,KAAX,CAAiBH,WAAjB,CAPQ;;AAAA;AAO/BI,0BAP+B;;AAQrCd,qBAAS,IAAT,EAAec,eAAeG,IAA9B;;AARqC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAN;;AAAA;AAAA;AAAA;AAAA,IAAjC;;AAWArB,OAAOC,OAAP,CAAewC,SAAf,GAA2B5C;AAAA,uFAAM,kBAAOM,KAAP,EAAcjB,OAAd,EAAuBkB,QAAvB;AAAA;AAAA;AAAA;AAAA;AAAA;AACvBsC,yBADuB,GACLvC,MAAMwC,OADD,CACvBD,aADuB;AAEzBE,iBAFyB,GAEjBF,cAAcF,KAAd,CAAoB,GAApB,EAAyB,CAAzB,CAFiB;AAGzBK,mBAHyB,GAGfvE,IAAIwE,MAAJ,CAAWF,KAAX,EAAkBlE,QAAQC,GAAR,CAAYoE,MAA9B,CAHe;AAIzBC,0BAJyB,GAIR;AACrBjC,8MADqB;AAMrBC,sBAAQ,CAAC6B,QAAQtB,EAAT;AANa,aAJQ;AAAA;AAAA,mBAYRrC,QAAQC,EAAR,CAAW8B,KAAX,CAAiB+B,cAAjB,CAZQ;;AAAA;AAYzBvD,oBAZyB;AAAA;AAAA,mBAaHP,QAAQC,EAAR,CAAW8B,KAAX,gDAbG;;AAAA;AAazBgC,yBAbyB;;AAgB/B7C,qBAAS,IAAT,EAAe;AACbqC,yBAAWhD,SAAS4B,IADP;AAEb6B,qBAAOD,cAAc5B,IAAd,CAAmB,CAAnB,EAAsB6B;AAFhB,aAAf;;AAhB+B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAN;;AAAA;AAAA;AAAA;AAAA,IAA3B,C;;;;;;ACxIA,sD;;;;;;ACAA,mE;;;;;;ACAA,kC;;;;;;ACAA,wC;;;;;;ACAA,8C;;;;;;ACAA,+B","file":"jfs.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 3);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap ec17d7f861ec1d8ca572","module.exports = require(\"babel-runtime/core-js/json/stringify\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"babel-runtime/core-js/json/stringify\"\n// module id = 0\n// module chunks = 0 1","module.exports = require(\"source-map-support/register\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"source-map-support/register\"\n// module id = 1\n// module chunks = 0 1","module.exports = require(\"jsonwebtoken\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"jsonwebtoken\"\n// module id = 2\n// module chunks = 0 1","'use strict'\n\nconst middy = require('middy')\nconst createErr = require('http-errors')\nconst {\n  urlEncodeBodyParser,\n  httpErrorHandler,\n  cors\n} = require('middy/middlewares')\nvar jwt = require('jsonwebtoken')\n\nconst { Pool } = require('pg')\n\nconst pool = new Pool({\n  connectionString: process.env.dbUrl\n})\n\nconst databaseMiddleware = config => ({\n  before: async (handler, next) => {\n    handler.context.db = await pool.connect()\n    next()\n  },\n  after: (handler, next) => {\n    handler.context.db.release(true)\n    next()\n  }\n})\n\n// Should be added last in the chain (so closest on the onion)\nconst detectingResponseType = (config = {}) => ({\n  after: (handler, next) => {\n    // handler.response has our value\n    let value = handler.response\n\n    if (value === null) {\n      value = {\n        statusCode: 404,\n        body: {\n          message: 'Not found'\n        }\n      }\n    } else {\n      value = {\n        statusCode: config.statusCode || 200,\n        body: JSON.stringify(value)\n      }\n    }\n\n    handler.response = value\n    next()\n  }\n})\n\nconst curry = fn => {\n  return middy(fn)\n    .use(urlEncodeBodyParser())\n    .use(cors())\n    .use(databaseMiddleware())\n    .use(httpErrorHandler())\n    .use(detectingResponseType())\n}\n\nmodule.exports.root = curry((event, context, callback) => {\n  callback(null, { message: 'ok' })\n})\n\nmodule.exports.register = curry(async (event, context, callback) => {\n  const {\n    inviteCode,\n    firstName,\n    lastName,\n    email,\n    facebook_avatar,\n    zip\n  } = JSON.parse(event.body)\n\n  const friendQuery = {\n    text: 'SELECT * FROM prelaunch.registration where email = $1 OR id::varchar = $1',\n    values: [inviteCode]\n  }\n  const friendResponse = await context.db.query(friendQuery)\n  console.log(friendQuery, friendResponse)\n  if (!friendResponse.rows[0]) {\n    callback(createErr(400, 'Invite Code was not valid.'))\n  }\n  const friendId = friendResponse.rows[0].id\n\n  const registerQuery = {\n    text: `UPDATE\n      prelaunch.registration\n      SET first_name = $1, last_name = $2, email = $3, avatar_url = $4, postal_code = $5, sponsor_id = $6 \n      WHERE facebook_email = $3`,\n    values: [firstName, lastName, email, facebook_avatar, zip, friendId]\n  }\n  await context.db.query(registerQuery)\n\n  const getQuery = {\n    text: 'SELECT * FROM prelaunch.registration where email = $1',\n    values: [email]\n  }\n  const getResponse = await context.db.query(getQuery)\n\n  callback(null, getResponse.rows[0])\n})\n\nmodule.exports.search = curry(async (event, context, callback) => {\n  const name = event.queryStringParameters.name\n  const searchQuery = {\n    text: 'SELECT * FROM prelaunch.registration WHERE lower(first_name) like %$1% OR lower(last_name) %$1%',\n    values: [name.toLowerCase()]\n  }\n  const searchResponse = await context.db.query(searchQuery)\n  callback(null, searchResponse.rows[0])\n})\n\nmodule.exports.getUser = curry(async (event, context, callback) => {\n  const id = event.pathParameters.id\n  const userQuery = {\n    text: 'SELECT * FROM prelaunch.registration where id = $1',\n    values: [id]\n  }\n  const userResponse = await context.db.query(userQuery)\n  callback(null, userResponse.rows[0])\n})\n\nmodule.exports.facebookFriends = curry(async (event, context, callback) => {\n  const ids = event.queryStringParameters.ids\n  const facebookIds = ids.split(',')\n  const friendQuery = {\n    text: 'SELECT * FROM prelaunch.registration WHERE facebook_id IN $1',\n    values: [facebookIds]\n  }\n  const friendResponse = await context.db.query(friendQuery)\n  callback(null, friendResponse.rows)\n})\n\nmodule.exports.influence = curry(async (event, context, callback) => {\n  const { Authorization } = event.headers\n  const token = Authorization.split(' ')[1]\n  const decoded = jwt.verify(token, process.env.jwtKey)\n  const influenceQuery = {\n    text: `select d.*\n      from prelaunch.genealogy d\n      inner join prelaunch.genealogy target on target.id = $1\n      where d.path[target.depth] = target.id\n        and d.id != target.id`,\n    values: [decoded.id]\n  }\n  const response = await context.db.query(influenceQuery)\n  const countResponse = await context.db.query(\n    `SELECT COUNT(id) FROM prelaunch.registration`\n  )\n  callback(null, {\n    influence: response.rows,\n    count: countResponse.rows[0].count\n  })\n})\n\n\n\n// WEBPACK FOOTER //\n// ./jfs.js","module.exports = require(\"babel-runtime/regenerator\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"babel-runtime/regenerator\"\n// module id = 4\n// module chunks = 0","module.exports = require(\"babel-runtime/helpers/asyncToGenerator\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"babel-runtime/helpers/asyncToGenerator\"\n// module id = 5\n// module chunks = 0","module.exports = require(\"middy\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"middy\"\n// module id = 6\n// module chunks = 0","module.exports = require(\"http-errors\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"http-errors\"\n// module id = 7\n// module chunks = 0","module.exports = require(\"middy/middlewares\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"middy/middlewares\"\n// module id = 8\n// module chunks = 0","module.exports = require(\"pg\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"pg\"\n// module id = 9\n// module chunks = 0"],"sourceRoot":""}