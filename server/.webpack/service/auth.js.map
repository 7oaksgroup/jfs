{"version":3,"sources":["webpack:///webpack/bootstrap ec17d7f861ec1d8ca572","webpack:///external \"babel-runtime/core-js/json/stringify\"","webpack:///external \"source-map-support/register\"","webpack:///external \"jsonwebtoken\"","webpack:///./auth.js","webpack:///external \"babel-runtime/core-js/object/assign\"","webpack:///external \"oauth\"","webpack:///external \"https\"","webpack:///external \"knex\""],"names":["OAuth2","require","https","jwt","oauth2","process","env","appKey","appSecret","options","redirect_uri","redirectUrl","module","exports","facebook","event","context","callback","queryStringParameters","error","console","log","getFailureResponse","code","statusCode","headers","Location","getOAuthAccessToken","access_token","refresh_token","results","url","get","res","body","on","chunk","json","JSON","parse","user","facebookId","id","name","email","avatar","picture","data","pg","client","connection","dbUrl","select","where","facebook_id","then","rows","length","insert","facebook_name","facebook_email","facebook_avatar","returning","getSuccessResponse","destroy","extra","token","sign","jwtKey","response"],"mappings":"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","file":"auth.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 10);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap ec17d7f861ec1d8ca572","module.exports = require(\"babel-runtime/core-js/json/stringify\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"babel-runtime/core-js/json/stringify\"\n// module id = 0\n// module chunks = 0 1","module.exports = require(\"source-map-support/register\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"source-map-support/register\"\n// module id = 1\n// module chunks = 0 1","module.exports = require(\"jsonwebtoken\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"jsonwebtoken\"\n// module id = 2\n// module chunks = 0 1","'use strict'\n\nvar OAuth2 = require('oauth').OAuth2\nvar https = require('https')\nvar jwt = require('jsonwebtoken')\n\nvar oauth2 = new OAuth2(\n  process.env.appKey,\n  process.env.appSecret,\n  'https://graph.facebook.com/',\n  null,\n  'v2.8/oauth/access_token'\n)\n\nvar options = {\n  redirect_uri: process.env.redirectUrl\n}\n\nmodule.exports.facebook = (event, context, callback) => {\n  /*\n  * return error if query string has an error parameter. e.g. if user\n  * declines to grant access.\n  * error=access_denied&error_code=200&error_description=Permissions+error&error_reason=user_denied\n  */\n  if (event.queryStringParameters && event.queryStringParameters.error) {\n    console.log(event.queryStringParameters)\n    callback(null, getFailureResponse(event.queryStringParameters))\n  } else if (\n    !event.queryStringParameters || !event.queryStringParameters.code\n  ) {\n    // redirect to facebook if \"code\" is not provided in the query string\n    callback(null, {\n      statusCode: 302,\n      headers: {\n        Location: 'https://www.facebook.com/v2.11/dialog/oauth' +\n          '?client_id=' +\n          process.env.appKey +\n          '&redirect_uri=' +\n          process.env.redirectUrl +\n          '&scope=email,user_friends'\n      }\n    })\n  } else {\n    // process request from facebook that has \"code\"\n    oauth2.getOAuthAccessToken(\n      event.queryStringParameters.code,\n      options,\n      function(error, access_token, refresh_token, results) {\n        if (error) {\n          console.log(error)\n          callback(null, getFailureResponse(error))\n        }\n\n        var url =\n          'https://graph.facebook.com/me?fields=id,name,email,picture,friends&access_token=' +\n          access_token\n\n        https\n          .get(url, function(res) {\n            console.log('got response: ' + res.statusCode)\n\n            var body = ''\n\n            res.on('data', function(chunk) {\n              body += chunk\n            })\n\n            res.on('end', function() {\n              var json = JSON.parse(body)\n              console.log('FACEBOOK RESPONSE', json)\n              var user = {\n                facebookId: json.id,\n                name: json.name,\n                email: json.email,\n                avatar: json.picture.data.url\n              }\n\n              var pg = require('knex')({\n                client: 'pg',\n                connection: process.env.dbUrl\n              })\n\n              pg('prelaunch.registration')\n                .select('*')\n                .where({ facebook_id: user.facebookId })\n                .then(function(rows) {\n                  if (rows.length > 0) {\n                    return rows\n                  } else {\n                    return pg('prelaunch.registration')\n                      .insert({\n                        facebook_id: user.facebookId,\n                        facebook_name: user.name,\n                        facebook_email: user.email,\n                        facebook_avatar: user.avatar,\n                        email: user.email\n                      })\n                      .returning('*')\n                  }\n                })\n                .then(function(rows) {\n                  callback(\n                    null,\n                    getSuccessResponse(Object.assign({}, rows[0]), json)\n                  )\n                  pg.destroy()\n                })\n            })\n          })\n          .on('error', function(error) {\n            console.log(error)\n            callback(null, getFailureResponse(error))\n            pg.destroy()\n          })\n      }\n    )\n  }\n}\n\nfunction getSuccessResponse(user, extra) {\n  var token = jwt.sign(user, process.env.jwtKey)\n  var response = {\n    statusCode: 200,\n    headers: {\n      'Access-Control-Allow-Origin': '*' // Required for CORS support to work\n    },\n    body: JSON.stringify({ jwt: token, extra: extra })\n  }\n  return response\n}\n\nfunction getFailureResponse(error) {\n  // this pretty raw... were just going to return a crude error... you could\n  // do something pretty here\n  var response = {\n    statusCode: 400,\n    headers: {\n      'Access-Control-Allow-Origin': '*' // Required for CORS support to work\n    },\n    body: JSON.stringify(error)\n  }\n  return response\n}\n\n\n\n// WEBPACK FOOTER //\n// ./auth.js","module.exports = require(\"babel-runtime/core-js/object/assign\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"babel-runtime/core-js/object/assign\"\n// module id = 11\n// module chunks = 1","module.exports = require(\"oauth\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"oauth\"\n// module id = 12\n// module chunks = 1","module.exports = require(\"https\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"https\"\n// module id = 13\n// module chunks = 1","module.exports = require(\"knex\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"knex\"\n// module id = 14\n// module chunks = 1"],"sourceRoot":""}